<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Secure PDF QR System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/verification-styles.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="8" fill="url(#gradient)" />
                    <path d="M12 12h6v6h-6v-6zm0 10h6v6h-6v-6zm10-10h6v6h-6v-6z" fill="white" />
                    <defs>
                        <linearGradient id="gradient" x1="0" y1="0" x2="40" y2="40">
                            <stop offset="0%" stop-color="#667eea" />
                            <stop offset="100%" stop-color="#764ba2" />
                        </linearGradient>
                    </defs>
                </svg>
                <h1>Secure PDF QR</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userEmail"></span>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <!-- Auth Section -->
        <div id="authSection" class="section">
            <div class="auth-container">
                <div class="auth-tabs">
                    <button class="tab-btn active" onclick="showTab('login')">Login</button>
                    <button class="tab-btn" onclick="showTab('register')">Register</button>
                </div>

                <!-- Login Form -->
                <div id="loginTab" class="tab-content active">
                    <h2>Welcome Back</h2>
                    <form onsubmit="login(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required placeholder="you@example.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="btn-primary">Login</button>
                    </form>
                </div>

                <!-- Register Form -->
                <div id="registerTab" class="tab-content">
                    <h2>Create Account</h2>
                    <form onsubmit="register(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required placeholder="you@example.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="appSection" class="section" style="display: none;">
            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="showSection('upload')">
                    üì§ Upload PDF
                </button>
                <button class="nav-btn" onclick="showSection('scan')">
                    üì∑ Scan & Verify QR
                </button>
                <button class="nav-btn" onclick="showSection('documents')">
                    üìÑ My Documents
                </button>
            </div>

            <!-- Upload Section -->
            <div id="uploadSection" class="content-section active">
                <div class="card">
                    <h2>Upload PDF Document</h2>
                    <form onsubmit="uploadPDF(event)" class="upload-form">
                        <div class="file-upload">
                            <input type="file" id="pdfFile" accept=".pdf" required onchange="updateFileName()">
                            <label for="pdfFile" class="file-label">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" />
                                </svg>
                                <span id="fileName">Choose PDF file</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Scan Limit</label>
                            <input type="number" id="scanLimit" required min="1" value="5"
                                placeholder="Maximum scans allowed">
                            <small>Number of times this QR code can be scanned</small>
                        </div>
                        <button type="submit" class="btn-primary">Upload & Generate QR</button>
                    </form>
                </div>

                <!-- Upload Result -->
                <div id="uploadResult" class="card result-card" style="display: none;">
                    <h3>‚úÖ QR Code Generated!</h3>
                    <div class="qr-display">
                        <img id="qrImage" src="" alt="QR Code">
                        <div class="qr-info">
                            <p><strong>Filename:</strong> <span id="resultFilename"></span></p>
                            <p><strong>Unique ID:</strong> <code id="resultUniqueId"></code></p>
                            <p><strong>Scan Limit:</strong> <span id="resultScanLimit"></span></p>
                            <p><strong>Scans Used:</strong> <span id="resultScanCount">0</span></p>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-primary" onclick="downloadQR()">Download QR Code</button>
                        <button class="btn-secondary" onclick="resetUpload()">Upload Another</button>
                    </div>
                </div>
            </div>

            <!-- Scan & Verify Section -->
            <div id="scanSection" class="content-section">
                <div class="card">
                    <h2>üì∑ Scan & Verify QR Code</h2>
                    <p class="section-description">Scan a QR code with your camera or upload an image to verify its
                        authenticity and access the document.</p>

                    <!-- Camera Scanner -->
                    <div class="scanner-container">
                        <div id="scanner" class="scanner"></div>
                        <div id="scannerPlaceholder" class="scanner-placeholder">
                            <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="7" height="7" />
                                <rect x="14" y="3" width="7" height="7" />
                                <rect x="3" y="14" width="7" height="7" />
                                <rect x="14" y="14" width="7" height="7" />
                            </svg>
                            <p>Use camera to scan QR code</p>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="startScanBtn" class="btn-primary" onclick="startScanner()">Start Camera</button>
                        <button id="stopScanBtn" class="btn-secondary" onclick="stopScanner()"
                            style="display: none;">Stop Camera</button>
                    </div>

                    <!-- OR Divider -->
                    <div class="or-divider">
                        <span>OR</span>
                    </div>

                    <!-- Upload QR Image -->
                    <div class="upload-verify-section">
                        <h3>Upload QR Code Image</h3>
                        <p class="upload-hint">Upload a photo of the QR code - we'll automatically detect and verify it
                        </p>
                        <form onsubmit="verifyUploadedQR(event)" class="verify-upload-form">
                            <div class="file-upload">
                                <input type="file" id="scanQRImage" accept="image/*" required
                                    onchange="handleQRImageUpload()">
                                <label for="scanQRImage" class="file-label">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                        <circle cx="8.5" cy="8.5" r="1.5" />
                                        <polyline points="21 15 16 10 5 21" />
                                    </svg>
                                    <span id="scanFileName">Choose QR code image</span>
                                </label>
                                <small>Upload a photo or screenshot of the QR code</small>
                            </div>

                            <!-- Hidden field for unique ID (auto-filled) -->
                            <input type="hidden" id="scanUniqueId" required>

                            <!-- Status message -->
                            <div id="qrDecodeStatus" class="decode-status" style="display: none;"></div>

                            <button type="submit" class="btn-primary" id="verifyButton" disabled>üîç Verify & Access
                                Document</button>
                        </form>

                        <!-- Hidden div for QR code reader - using visibility hidden instead of display none due to potential library constraints -->
                        <div id="reader"
                            style="visibility: hidden; position: fixed; top: -1000px; width: 300px; height: 300px;">
                        </div>
                    </div>
                </div>

                <!-- Scan Result -->
                <div id="scanResult" class="card result-card" style="display: none;">
                    <div id="scanSuccess" style="display: none;">
                        <div class="verdict-header">
                            <h3 id="scanVerdictTitle">‚úÖ AUTHENTIC</h3>
                            <div class="authenticity-score">
                                <div class="score-circle score-authentic" id="scanScoreCircle">
                                    <span id="scanScoreValue"></span>
                                </div>
                            </div>
                        </div>

                        <div class="scan-info">
                            <p><strong>Document:</strong> <span id="scanFilename"></span></p>
                            <p><strong>Scans Used:</strong> <span id="scanUsedCount"></span> / <span
                                    id="scanTotalLimit"></span></p>
                        </div>

                        <!-- Security Summary -->
                        <div class="security-summary">
                            <h4>Security Check Summary</h4>
                            <div class="security-badges">
                                <span class="security-badge" id="scanGhostBadge">üëª Ghost Dots</span>
                                <span class="security-badge" id="scanFreqBadge">üåä Watermark</span>
                                <span class="security-badge" id="scanFingerprintBadge">üî¨ Fingerprint</span>
                                <span class="security-badge" id="scanMetadataBadge">üìä Metadata</span>
                            </div>
                        </div>

                        <!-- PDF Viewer -->
                        <div class="pdf-viewer-container">
                            <h4>Document Preview</h4>
                            <iframe id="pdfViewer" class="pdf-viewer"></iframe>
                        </div>


                        <button class="btn-secondary" onclick="resetScan()">Scan Another</button>
                    </div>

                    <div id="scanError" style="display: none;">
                        <div class="verdict-header">
                            <h3 id="scanErrorVerdictTitle">‚ùå COUNTERFEIT</h3>
                            <div class="authenticity-score">
                                <div class="score-circle score-counterfeit" id="scanErrorScoreCircle">
                                    <span id="scanErrorScoreValue"></span>
                                </div>
                            </div>
                        </div>

                        <div class="error-message">
                            <p id="scanErrorMessage"></p>
                        </div>

                        <!-- Security Details for Failed Verification -->
                        <div class="security-summary">
                            <h4>Why This QR Code Failed</h4>
                            <div class="security-details-compact">
                                <div class="detail-item">
                                    <span class="detail-label">üëª Ghost Dots:</span>
                                    <span class="detail-value" id="scanErrorGhost"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">üåä Watermark:</span>
                                    <span class="detail-value" id="scanErrorFreq"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">üî¨ Fingerprint:</span>
                                    <span class="detail-value" id="scanErrorFingerprint"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">üìä Metadata:</span>
                                    <span class="detail-value" id="scanErrorMetadata"></span>
                                </div>
                            </div>
                        </div>

                        <button class="btn-secondary" onclick="resetScan()">Try Another</button>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div id="documentsSection" class="content-section">
                <div class="card">
                    <h2>My Documents</h2>
                    <div id="documentsList" class="documents-list">
                        <p class="loading">Loading documents...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="toast"></div>
    </div>

    <!-- Include QR Scanner Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="/static/app.js?v=2"></script>
</body>

</html>